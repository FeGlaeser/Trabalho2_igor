<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerenciamento de Sess√µes</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container">
        <h1>üé• Gerenciamento de Sess√µes</h1>

        <h2>Cadastrar Nova Sess√£o</h2>
        <form id="formSessao">
            <label for="filmeId">ID do Filme:</label>
            <input type="number" id="filmeId" name="filmeId" required>

            <label for="salaId">ID da Sala:</label>
            <input type="number" id="salaId" name="salaId" required>

            <label for="dataHora">Data e Hora:</label>
            <input type="datetime-local" id="dataHora" name="dataHora" required>

            <label for="preco">Pre√ßo (R$):</label>
            <input type="number" step="0.01" id="preco" name="preco" required>

            <button type="submit">Cadastrar Sess√£o</button>
        </form>

        <div id="sessao-status"></div>

        <hr>

        <h2>Sess√µes Agendadas</h2>
        <table class="data-table" id="tabelaSessoes">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Filme ID</th>
                    <th>Sala ID</th>
                    <th>Data/Hora</th>
                    <th>Pre√ßo</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

    </div>

    <script>
        const API_URL = '/api/sessoes';
        const formSessao = document.getElementById('formSessao');
        const tabelaCorpo = document.querySelector('#tabelaSessoes tbody');
        const statusDiv = document.getElementById('sessao-status');

        // Fun√ß√£o para formatar a data/hora para exibi√ß√£o
        const formatarData = (dateTimeStr) => {
            const date = new Date(dateTimeStr);
            return date.toLocaleString('pt-BR');
        };

        // 1. Fun√ß√£o para Listar Sess√µes
        const buscarSessoes = async () => {
            try {
                const response = await fetch(API_URL);
                const sessoes = await response.json();
                
                tabelaCorpo.innerHTML = ''; // Limpa a tabela
                sessoes.forEach(sessao => {
                    const row = tabelaCorpo.insertRow();
                    row.insertCell().textContent = sessao.id;
                    row.insertCell().textContent = sessao.filmeId;
                    row.insertCell().textContent = sessao.salaId;
                    row.insertCell().textContent = formatarData(sessao.dataHora);
                    row.insertCell().textContent = `R$ ${sessao.preco.toFixed(2)}`;
                });

            } catch (error) {
                tabelaCorpo.innerHTML = '<tr><td colspan="5">Erro ao carregar sess√µes. Verifique o console.</td></tr>';
                console.error('Erro ao buscar sess√µes:', error);
            }
        };

        // 2. Fun√ß√£o para Cadastrar Sess√£o
        formSessao.addEventListener('submit', async (e) => {
            e.preventDefault();

            const sessaoData = {
                filmeId: parseInt(document.getElementById('filmeId').value),
                salaId: parseInt(document.getElementById('salaId').value),
                dataHora: document.getElementById('dataHora').value,
                preco: parseFloat(document.getElementById('preco').value)
            };
            
            statusDiv.className = '';
            statusDiv.textContent = 'Processando...';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sessaoData)
                });
                
                const result = await response.json(); // Tenta ler como JSON
                const resultText = response.status === 201 ? JSON.stringify(result) : result.result || result; // Pega o corpo do erro se n√£o for 201
                
                if (response.status === 201) {
                    statusDiv.className = 'sucesso';
                    statusDiv.textContent = 'Sess√£o cadastrada com sucesso!';
                    formSessao.reset();
                    buscarSessoes();
                } else {
                    statusDiv.className = 'erro';
                    statusDiv.textContent = `Erro ${response.status}: ${resultText}`;
                }

            } catch (error) {
                statusDiv.className = 'erro';
                statusDiv.textContent = 'Erro de comunica√ß√£o com a API.';
                console.error('Erro de requisi√ß√£o:', error);
            }
        });

        // Carrega a lista ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', buscarSessoes);
    </script>
</body>
</html>